<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <title>C64 DIAGNOSTICA</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <style>
    body { background: #000; color: #0f0; font-family: monospace; padding: 20px; font-size: 16px; }
    h1 { color: #fff; border-bottom: 1px solid #555; }
    #log { white-space: pre-wrap; }
    .error { color: red; font-weight: bold; }
    .ok { color: cyan; }
    button { font-size: 20px; padding: 10px 30px; background: yellow; border: none; cursor: pointer; display: block; margin-bottom: 20px;}
  </style>
</head>
<body>

<h1>DIAGNOSTICA ZIP</h1>
<button onclick="analizzaZip()">1. CLICCA QUI PER ANALIZZARE</button>
<div id="log">In attesa...</div>

<script>
  const ZIP_URL = "./bundle.zip?v=" + Math.random(); // Trucco anti-cache

  function log(text, type="") {
    const div = document.getElementById("log");
    div.innerHTML += `<div class="${type}">${text}</div>`;
  }

  async function analizzaZip() {
    const div = document.getElementById("log");
    div.innerHTML = "Inizio scaricamento bundle.zip...\n";
    
    try {
      const response = await fetch(ZIP_URL);
      if (!response.ok) throw new Error(`ERRORE: File bundle.zip non trovato (Status: ${response.status})`);
      
      log("Scaricamento OK. Apro lo ZIP...", "ok");
      const blob = await response.blob();
      const zip = await JSZip.loadAsync(blob);
      
      log("\n--- CONTENUTO DELLO ZIP ---");
      let fileCount = 0;
      let folderDetected = false;
      let d64Found = false;
      let romsFound = 0;

      zip.forEach((relativePath, zipEntry) => {
        fileCount++;
        let status = "[FILE]";
        if (zipEntry.dir) {
            status = "[CARTELLA]";
            folderDetected = true;
        }
        
        log(`${status} ${relativePath}`);

        // Analisi file
        const name = relativePath.toLowerCase();
        if (name.includes("/")) folderDetected = true; // C'Ã¨ una sottocartella!
        
        if (name.includes("basic")) romsFound++;
        if (name.includes("kernal")) romsFound++;
        if (name.includes("char")) romsFound++;
        if (name.endsWith(".d64") || name.endsWith(".tap")) d64Found = true;
      });

      log("\n--- RISULTATO ANALISI ---");
      
      if (fileCount === 0) {
          log("LO ZIP Ãˆ VUOTO!", "error");
          return;
      }

      if (folderDetected) {
          log("âŒ ERRORE GRAVE: Hai zippato una cartella!", "error");
          log("I file devono essere 'sciolti' nello zip, non dentro una cartella.", "error");
          log("SOLUZIONE: Dezippa tutto. Seleziona i FILE, tasto destro -> Crea ZIP.", "error");
      } else {
          log("âœ… Struttura cartelle: OK (Nessuna sottocartella)", "ok");
      }

      if (romsFound < 3) {
          log(`âŒ ERRORE: Mancano le ROM (Trovate: ${romsFound}/3)`, "error");
          log("Devi avere: basic, kernal, chargen", "error");
      } else {
          log("âœ… ROM trovate: OK", "ok");
      }

      if (!d64Found) {
          log("âŒ ERRORE: Non trovo il gioco (.d64 o .tap)", "error");
      } else {
          log("âœ… Gioco trovato: OK", "ok");
      }

      if (!folderDetected && romsFound >= 3 && d64Found) {
          log("\nðŸŽ‰ TUTTO PERFETTO! Il problema non sono i file.", "ok");
          log("Il problema Ã¨ l'emulatore. Torna da Gemini e dimmi 'I FILE SONO OK'.", "ok");
      }

    } catch (err) {
      log("ERRORE FATALE: " + err.message, "error");
    }
  }
</script>
</body>
</html>
