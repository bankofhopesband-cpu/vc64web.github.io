<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <title>Test ROM</title>
  <script src="./js/vc64web_player.js"></script>
  <style>
    body { background: #111; color: white; font-family: sans-serif; text-align: center; padding-top: 50px; }
    button { padding: 20px 40px; font-size: 24px; font-weight: bold; cursor: pointer; background: red; color: white; border: none; }
    #p { margin: 20px auto; width: 80%; height: 600px; background: #000; border: 2px solid #555; }
  </style>
</head>
<body>

<button id="btnStart">CLICCA PER TESTARE LE ROM</button>

<div id="p"></div>

<script>
  // I TUOI LINK (Controllali!)
  const ROM_URLS = {
    basic:   "https://lucent-marzipan-81e5b7.netlify.app/roms/basic.bin",
    kernal:  "https://lucent-marzipan-81e5b7.netlify.app/roms/kernal.bin",
    char:    "https://lucent-marzipan-81e5b7.netlify.app/roms/chargen.bin",
    d1541:   "https://lucent-marzipan-81e5b7.netlify.app/roms/d1541II.bin"
  };

  document.getElementById("btnStart").addEventListener("click", async () => {
    
    // 1. PRIMO POPUP DI CONTROLLO
    alert("Inizio il test. Se leggi questo, il codice Ã¨ nuovo.");

    try {
      const romBlobs = {};
      let report = "Report Scaricamento:\n";

      for (const [key, url] of Object.entries(ROM_URLS)) {
        // Scarichiamo il file
        const resp = await fetch(url);
        
        if (!resp.ok) {
           alert("ERRORE CRITICO!\nNon riesco a trovare: " + key + "\nLink provato: " + url);
           return; // Ci fermiamo subito
        }
        
        const blob = await resp.blob();
        report += key + ": OK (" + blob.size + " bytes)\n";
        romBlobs[key] = URL.createObjectURL(blob);
      }

      // 2. SECONDO POPUP: TUTTO OK
      alert(report + "\n\nAdesso provo a lanciare l'emulatore.");

      // Configurazione
      const config = {
        navbar: true, wide: true, port2: true,
        dialog_on_missing_roms: false, // ZITTO E CARICA
        roms: {
            basic:   romBlobs.basic,
            kernal:  romBlobs.kernal,
            char:    romBlobs.char,
            chargen: romBlobs.char, 
            d1541:   romBlobs.d1541
        },
        buttons: [{
          run: true,
          script: `(async function() {
             await wasm_ready_after_reset();
             const s = (ms) => new Promise(r => setTimeout(r, ms));
             await s(1000);
             const t = async(text) => { for(let c of text) { await action(c); await s(20); } };
             await t('LOAD"*",8,1'); await action('=>Enter');
             await disk_loading_finished();
             await s(500);
             await t('RUN'); await action('=>Enter');
          })()`
        }]
      };

      vc64web_player.samesite_file = { url: "./gioco.d64", name: "gioco.d64" };
      vc64web_player.load(document.getElementById("p"), encodeURIComponent(JSON.stringify(config)));

    } catch (err) {
      alert("ERRORE SCONOSCIUTO:\n" + err.message);
    }
  });
</script>
</body>
</html>
