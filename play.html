<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <title>C64 Base64 Loader</title>
  <script src="./js/vc64web_player.js"></script>
  <style>
    body { background: #111; color: white; font-family: sans-serif; padding: 20px; text-align: center; }
    #status { padding: 15px; margin-bottom: 20px; border: 1px solid #444; background: #222; white-space: pre-line; }
    button { padding: 15px 30px; font-size: 20px; cursor: pointer; background: #00aa00; color: white; border: none; font-weight: bold; border-radius: 8px; }
    #p { width: 90%; height: 70vh; background: #000; border: 2px solid #666; margin: 0 auto; }
  </style>
</head>
<body>

<div id="status">Premi il pulsante per caricare e convertire le ROM.</div>
<button id="btnStart">AVVIA GIOCO (Iniezione Diretta)</button>

<div id="p"></div>

<script>
  const statusDiv = document.getElementById("status");
  function log(msg) { statusDiv.innerHTML += "\n" + msg; }

  // I TUOI LINK FUNZIONANTI
  const ROM_URLS = {
    basic:   "https://lucent-marzipan-81e5b7.netlify.app/roms/basic.bin",
    kernal:  "https://lucent-marzipan-81e5b7.netlify.app/roms/kernal.bin",
    char:    "https://lucent-marzipan-81e5b7.netlify.app/roms/chargen.bin",
    d1541:   "https://lucent-marzipan-81e5b7.netlify.app/roms/d1541II.bin"
  };

  // Funzione per convertire il file in stringa Base64
  const blobToBase64 = (blob) => {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onloadend = () => resolve(reader.result);
      reader.onerror = reject;
      reader.readAsDataURL(blob);
    });
  };

  document.getElementById("btnStart").addEventListener("click", async () => {
    const btn = document.getElementById("btnStart");
    btn.disabled = true;
    btn.innerText = "Caricamento in corso...";
    statusDiv.innerHTML = "Inizio procedura di iniezione...";

    try {
      const romDataURIs = {};

      for (const [key, url] of Object.entries(ROM_URLS)) {
        log(`Scarico ${key}...`);
        const resp = await fetch(url);
        if (!resp.ok) throw new Error(`Errore scaricamento ${key}`);
        
        const blob = await resp.blob();
        log(`Converto ${key} in Base64...`);
        // Qui avviene la magia: trasformiamo il file in una stringa "data:..."
        const base64Data = await blobToBase64(blob);
        romDataURIs[key] = base64Data;
      }

      log("Tutte le ROM pronte. Configuro l'emulatore...");

      const config = {
        navbar: true, wide: true, port2: true,
        dialog_on_missing_roms: false, // Disabilita richiesta file
        roms: {
            // Passiamo direttamente i dati, non i link!
            basic:   romDataURIs.basic,
            kernal:  romDataURIs.kernal,
            char:    romDataURIs.char,
            chargen: romDataURIs.char, 
            d1541:   romDataURIs.d1541
        },
        buttons: [{
          run: true,
          script: `(async function() {
             await wasm_ready_after_reset();
             const s = (ms) => new Promise(r => setTimeout(r, ms));
             await s(1000);
             const t = async(text) => { for(let c of text) { await action(c); await s(20); } };
             await t('LOAD"*",8,1'); await action('=>Enter');
             await disk_loading_finished();
             await s(500);
             await t('RUN'); await action('=>Enter');
          })()`
        }]
      };

      vc64web_player.samesite_file = { url: "./gioco.d64", name: "gioco.d64" };
      
      vc64web_player.load(document.getElementById("p"), encodeURIComponent(JSON.stringify(config)));
      
      btn.style.display = 'none';
      log("Emulatore avviato!");

    } catch (err) {
      alert("ERRORE: " + err.message);
      btn.disabled = false;
      btn.innerText = "Riprova";
    }
  });
</script>
</body>
</html>
