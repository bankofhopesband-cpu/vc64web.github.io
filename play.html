<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Play - C64 Online</title>

  <script src="./js/vc64web_player.js"></script>

  <style>
    body { font-family: system-ui, Arial, sans-serif; margin: 16px; }
    .wrap { max-width: 1100px; margin: 0 auto; }
    .box { border: 1px solid #ccc; border-radius: 12px; padding: 12px; margin-bottom: 12px; }
    #p { width: 100%; height: 78vh; background: #000; border-radius: 12px; overflow: hidden; }
    button, a.btn {
      display: inline-block;
      padding: 10px 16px;
      font-weight: 900;
      cursor: pointer;
      border: 1px solid #222;
      border-radius: 10px;
      background: #fff;
      color: #000;
      text-decoration: none;
      margin-right: 8px;
      margin-top: 6px;
    }
    code { font-weight: 900; }
    .small { font-size: 0.95em; opacity: 0.85; }
  </style>
</head>

<body>
<div class="wrap">
  <div class="box">
    <h2 style="margin:0 0 8px 0;">BANK OF HOPES - C64</h2>
    <div class="small" style="margin:0 0 10px 0;">Premi PLAY per iniziare.</div>
    <div style="margin:0 0 10px 0;">
      <button id="go">PLAY</button>
      <a class="btn" href="./gioco.d64">Scarica D64</a>
    </div>
    <div class="small">Se resta su READY, attendi qualche secondo l'avvio automatico.</div>
  </div>
  <div id="p"></div>
</div>

<script>
  // --- PULIZIA CACHE ---
  if(window.navigator && navigator.serviceWorker) {
    navigator.serviceWorker.getRegistrations().then(function(registrations) {
      for(let registration of registrations) { registration.unregister(); }
    });
  }

  // --- FUNZIONE DI AUTORUN CHE CONTIENE TUTTO ---
  async function autorun() {
    // DEFINIAMO LE FUNZIONI DI AIUTO QUI DENTRO
    // Così l'emulatore può vederle!
    const sleep = (ms) => new Promise(r => setTimeout(r, ms));
    
    async function typeSlow(text) {
      for (const ch of text) {
        await action(`${ch}`);
        await sleep(18); // Velocità digitazione
      }
    }

    // INIZIO SEQUENZA
    await wasm_ready_after_reset();
    await sleep(500); // Pausa di sicurezza iniziale

    // LOAD
    await typeSlow('LOAD"*",8,1');
    await action(`=>Enter`);

    await disk_loading_finished();
    await sleep(500); // Pausa post caricamento

    // RUN
    await typeSlow('RUN');
    await action(`=>Enter`);
  }

  document.getElementById("go").addEventListener("click", () => {
    const config = {
      navbar: true,
      wide: true,
      port2: true,
      border: 0.3,
      dialog_on_missing_roms: false,

      // PERCORSI ROM
      // Assicurati al 100% che su GitHub nella cartella 'roms' i file si chiamino COSI' (minuscolo)
      roms: {
          basic:   "./roms/basic.bin",
          kernal:  "./roms/kernal.bin",
          char:    "./roms/chargen.bin",
          chargen: "./roms/chargen.bin", 
          d1541:   "./roms/d1541II.bin"
      },

      buttons: [{
        run: true,
        script: `(${autorun.toString()})();`
      }]
    };

    vc64web_player.samesite_file = {
      url: "./gioco.d64",
      name: "gioco.d64"
    };

    vc64web_player.load(
      document.getElementById("p"),
      encodeURIComponent(JSON.stringify(config))
    );
  });
</script>
</body>
</html>
